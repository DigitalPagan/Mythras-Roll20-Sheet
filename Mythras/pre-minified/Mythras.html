<!-- Sheet type at very top to influence the rest -->
<input class="sheet-typetoggle" type="hidden" name="attr_type" value="pc">
<input class="sheet-setting-control" type="hidden" name="attr_setting" value="default">
<input class="sheet-compact-control" type="hidden" name="attr_compact" value="0">
<div class="sheet-wrapper">
    <!-- Floating Option Bar -->
    <div class="sheet-option-bar">
    <!-- Options -->
    <div class="sheet-space-between sheet-gap">
        <!-- Option Bar Left -->
        <div class="sheet-flex sheet-gap">
            <!-- Whisper Toggle -->
            <div><input data-i18n-title="whisper_rolls_to_gm" type='checkbox' name='attr_roll_display' value="/w gm" checked><span class="sheet-checkico">q</span></div>

            <!-- Skill Difficulty Option -->
            <div class="sheet-flex sheet-gap">
                <label class="sheet-left sheet-large-screen" data-i18n="difficulty">Difficulty</label>
                <label class="sheet-left sheet-small-screen" data-i18n-title="difficulty" data-i18n="difficulty-abrv">Diff</label>
                <select class="sheet-auto-width sheet-undrln sheet-text-center sheet-inverted" name="attr_difficulty">
                    <option value="0" data-i18n="verbose" selected>verbose</option>
                    <option value="1" data-i18n="very_easy">Very Easy</option>
                    <option value="2" data-i18n="easy">Easy</option>
                    <option value="3" data-i18n="standard">Standard</option>
                    <option value="4" data-i18n="hard">Hard</option>
                    <option value="5" data-i18n="formidable">Formidable</option>
                    <option value="6" data-i18n="herculean">Herculean</option>
                </select>
            </div>

            <!-- Augment Option -->
            <div class="sheet-flex sheet-gap">
                <label class="sheet-left sheet-large-screen" data-i18n="augmentation">Augmentation</label>
                <label class="sheet-left sheet-small-screen" data-i18n-title="augmentation" data-i18n="augmentation-abrv">Aug</label>
                <select class="sheet-auto-width sheet-undrln sheet-text-center sheet-inverted" title="@{augmentation}" name="attr_augmentation">
                    <option value="@{set_augmentation}" data-i18n="set" selected>Set</option>
                    <option value="?{Augmentation|0}" data-i18n="prompt">Prompt</option>
                </select>
                <input type="hidden" class="sheet-set-toggle" name="attr_augmentation" value="@{set_augmentation}">
                <input type="number" class="sheet-number-width-sm sheet-undrln sheet-toggle" name="attr_set_augmentation" value="0">
            </div>

            <!-- 101+ Penalty Option -->
            <div class="sheet-flex sheet-gap">
                <label class="sheet-left sheet-large-screen" data-i18n="101+_penalty">101+ Penalty</label>
                <label class="sheet-left sheet-small-screen" data-i18n-title="101+_penalty">101+</label>
                <select class="sheet-auto-width sheet-undrln sheet-text-center sheet-inverted" title="@{penalty}" name="attr_penalty">
                    <option value="@{set_penalty}" data-i18n="set" selected>Set</option>
                    <option value="?{101+ Penalty|0}" data-i18n="prompt">Prompt</option>
                </select>
                <input type="hidden" class="sheet-set-toggle" name="attr_penalty" value="@{set_penalty}">
                <input type="number" class="sheet-number-width-sm sheet-undrln sheet-toggle" name="attr_set_penalty" value="0">
            </div>
        </div>
        <!-- Option Bar Right -->
        <div class="sheet-flex sheet-gap">
            <div><input type='checkbox' data-i18n-title="compact_mode" name='attr_compact' value="1"><span class="sheet-checkico">J</span></div>
            <!--<div class="sheet-character"><input class="sheet-checkbtn" type="hidden" name="attr_compact" value="0"><button type="action" class="sheet-checkbtn" name="act_compact" data-i18n="compact">Compact</button></div>-->
            <a class="sheet-pictos" data-i18n-title="show_help_popup" href="#help">?</a>
            <a class="sheet-pictos" data-i18n-title="show_import_popup" href="#import">~</a>
            <a class="sheet-pictos" data-i18n-title="show_configuration_popup" href="#configuration">y</a>
        </div>
    </div>

    <!-- Sheet Tabs -->
    <div class="sheet-detailed">
    <div class="sheet-flex sheet-gap">
        <a href="#core">Core</a>
        -
        <a href="#abilities">Abilities</a>
        -
        <a href="#other">other</a>
    </div>
</div>
</div>

    <!-- Sheet Types -->
    
    
<div class="sheet-character">
    <div class="sheet-detailed">
    <!-- Character Header -->
    <div class="sheet-flex sheet-gap">
        <!-- Info Section -->
        <div class="sheet-section sheet-grow">
            <!-- Info 1st Row -->
            <div class="sheet-flex sheet-gap">
                <div class="sheet-grow">
                    <input type="text" class="sheet-full-width" title="@{character_name}" name="attr_character_name">
                    <label data-i18n="name">Name</label>
                </div>
                <div class="sheet-grow">
                    <input type="text" class="sheet-full-width" title="@{species}" name="attr_species">
                    <span class="sheet-setting-option sheet-not-cf"><label data-i18n="species">Species</label></span>
                    <span class="sheet-setting-option sheet-cf"><label data-i18n="race">Race</label></span>
                </div>
                <div class="sheet-grow">
                    <input type="text" class="sheet-full-width" title="@{culture}" name="attr_culture">
                    <label data-i18n="culture">Culture</label>
                </div>
                <div class="sheet-grow">
                    <input type="text" class="sheet-full-width" title="@{career}" name="attr_career">
                    <span class="sheet-setting-option sheet-not-cf"><label data-i18n="career">Career</label></span>
                    <span class="sheet-setting-option sheet-cf"><label data-i18n="class">Class</label></span>
                </div>
                <div class="sheet-setting-option sheet-cf sheet-info-rank">
                    <input type="number" class="sheet-full-width" title="@{rank}" name="attr_rank" value="0">
                    <label data-i18n="rank">Rank</label>
                </div>
            </div>
            <!-- Info 2nd Row -->
            <div class="sheet-flex sheet-gap">
                <div class="sheet-grow">
                    <input type="text" class="sheet-full-width" title="@{homeland}" name="attr_homeland">
                    <label data-i18n="homeland">Homeland</label>
                </div>
                <div class="sheet-grow">
                    <input type="text" class="sheet-full-width" title="@{social_class}" name="attr_social_class">
                    <label data-i18n="social_class">Name</label>
                </div>
                <div class="sheet-info-age">
                    <input type="number" class="sheet-full-width" title="@{age}" name="attr_age" value="0">
                    <label data-i18n="age">Age</label>
                </div>
                <div class="sheet-info-gender">
                    <input type="text" class="sheet-full-width" title="@{gender}" name="attr_gender">
                    <label data-i18n="gender">Gender</label>
                </div>
                <div class="sheet-info-frame">
                    <input type="text" class="sheet-full-width" title="@{frame}" name="attr_frame">
                    <label data-i18n="frame">Gender</label>
                </div>
                <div class="sheet-info-height">
                    <input type="number" style="padding-right: 25px" class="sheet-full-width" title="@{height}" name="attr_height" value="178">
                    <span class="sheet-input-unit" data-i18n="centimetres-abrv">cm</span>
                    <label data-i18n="height-bugfix">Height</label>
                </div>
                <div class="sheet-info-weight">
                    <input type="number" style="padding-right: 20px" class="sheet-full-width" title="@{weight}" name="attr_weight" value="88">
                    <span class="sheet-input-unit" data-i18n="kilograms-abrv">kg</span>
                    <label data-i18n="weight">Weight</label>
                </div>
                <!-- TODO make the soot rollable ? -->
                <div class="sheet-setting-option sheet-os sheet-info-the-soot">
                    <input type="number" class="sheet-full-width" title="@{the_soot}" name="attr_the_soot" value="0">
                    <label data-i18n="the_soot">The Soot</label>
                </div>
            </div>
        </div>

        <!-- Header 2nd Column -->
        <div class="sheet-logo">
            <!-- Logo -->
            <div>
                <img class="sheet-setting-option sheet-default sheet-atvw sheet-cf sheet-destined sheet-fioracitta sheet-la sheet-lyonesse sheet-mi sheet-mba sheet-mb sheet-mc sheet-mr sheet-imperative sheet-perceforest sheet-thennla sheet-wu" src="https://i.imgur.com/EzQDmms.png" alt="Mythras">
                <img class="sheet-setting-option sheet-ms" src="https://i.imgur.com/5uPy3QU.jpg" alt="M-Space">
                <img class="sheet-setting-option sheet-os" src="https://i.imgur.com/35dOQix.jpg" alt="Odd Soot">
            </div>
            <!-- Experience Rolls -->
            <div class="sheet-flex sheet-gap">
                <label class="sheet-left" data-i18n="experience_rolls">Experience Rolls</label>
                <input type="number" class="sheet-grow" title="@{experience_rolls}" name="attr_experience_rolls" value="0">
            </div>
        </div>
    </div>

    <!-- Core Section -->
    <div class="sheet-flex sheet-gap">
        <!-- Characteristics -->
        <div class="sheet-section">
            <h2 data-i18n="characteristics">Characteristics</h2>

            <input class="sheet-deep-toggle" type='hidden' name='attr_extended_conflict_enabled' value="0">
            <div class="sheet-table">
                <div class="sheet-tr">
                    <div class="sheet-th"></div>
                    <div class="sheet-th" data-i18n="base">Base</div>
                    <div class="sheet-th" data-i18n-title="current" data-i18n="current-abrv">Curr</div>
                </div>

                <!-- STR -->
                <div class="sheet-tr sheet-hl sheet-creature">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left" data-i18n="str-u">STR</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{str_base}" name="attr_str_base" value="11"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{str}" name="attr_str" value="11">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{str_pool}" name="attr_str_pool" value="11">/<input type="number" class="sheet-rval" title="@{str}" name="attr_str" value="11"></div>
                    </div>
                    <input type="hidden" name="attr_str_temp" value="0">
                </div>

                <!-- CON -->
                <div class="sheet-tr sheet-hl sheet-creature">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left" data-i18n="con-u">CON</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{con_base}" name="attr_con_base" value="11"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{con}" name="attr_con" value="11">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{con_pool}" name="attr_con_pool" value="11">/<input type="number" class="sheet-rval" title="@{con}" name="attr_con" value="11"></div>
                    </div>
                    <input type="hidden" name="attr_con_temp" value="0">
                </div>

                <!-- SIZ -->
                <div class="sheet-tr sheet-hl sheet-creature">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left" data-i18n="siz-u">SIZ</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{siz_base}" name="attr_siz_base" value="13"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{siz}" name="attr_siz" value="13">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{siz_pool}" name="attr_siz_pool" value="13">/<input type="number" class="sheet-rval" title="@{siz}" name="attr_siz" value="13"></div>
                    </div>
                    <input type="hidden" name="attr_siz_temp" value="0">
                </div>

                <!-- DEX -->
                <div class="sheet-tr sheet-hl sheet-creature">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left" data-i18n="dex-u">DEX</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{dex_base}" name="attr_dex_base" value="11"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{dex}" name="attr_dex" value="11">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{dex_pool}" name="attr_dex_pool" value="11">/<input type="number" class="sheet-rval" title="@{dex}" name="attr_dex" value="11"></div>
                    </div>
                    <input type="hidden" name="attr_dex_temp" value="0">
                </div>

                <!-- INT -->
                <div class="sheet-tr sheet-hl">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left"><span name="attr_int_type" data-i18n-dynamic>INT</span></label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{int_base}" name="attr_int_base" value="13"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{int}" name="attr_int" value="13">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{int_pool}" name="attr_int_pool" value="13">/<input type="number" class="sheet-rval" title="@{int}" name="attr_int" value="13"></div>
                    </div>
                    <input type="hidden" name="attr_int_temp" value="0">
                </div>

                <!-- POW -->
                <div class="sheet-tr sheet-hl">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left" data-i18n="pow-u">POW</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{pow_base}" name="attr_pow_base" value="11"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{pow}" name="attr_pow" value="11">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{pow_pool}" name="attr_pow_pool" value="11">/<input type="number" class="sheet-rval" title="@{pow}" name="attr_pow" value="11"></div>
                    </div>
                    <input type="hidden" name="attr_pow_temp" value="0">
                </div>

                <!-- CHA -->
                <div class="sheet-tr sheet-hl">
                    <div class="sheet-td sheet-char-label"><label class="sheet-left" data-i18n="cha-u">CHA</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{cha_base}" name="attr_cha_base" value="11"></div>
                    <div class="sheet-td">
                        <input type="number" class="sheet-impval sheet-number-width sheet-anti-toggle" title="@{cha}" name="attr_cha" value="11">
                        <div class="sheet-impval sheet-number-width sheet-toggle"><input type="number" class="sheet-lval" title="@{cha_pool}" name="attr_cha_pool" value="11">/<input type="number" class="sheet-rval" title="@{cha}" name="attr_cha" value="11"></div>
                    </div>
                    <input type="hidden" name="attr_cha_temp" value="0">
                </div>
            </div>
            <div class="sheet-space-between sheet-gap sheet-toggle">
                <div>
                    <label class="sheet-left" data-i18n-title="conflict_pool" data-i18n="pool">Pool</label>
                    <input type="number" class="sheet-number-width-sm" title="@{conflict_pool}" name="attr_conflict_pool" value="11">/<input type="number" class="sheet-bold sheet-number-width-sm" title="@{conflict_pool|max}" name="attr_conflict_pool_max" value="11">
                </div>
                <div>
                    <button class="sheet-die" type="roll" title="%{extended_conflict_damage}" name="roll_extended_conlict_damage" value="@{roll_display}&{template:default} {{red=1}} {{name=^{extended_conflict_damage}}} {{character=@{character_name}}} {{^{damage}=[[1d6]]}}"><span class="sheet-d6">F</span></button>
                </div>
            </div>
        </div>

        <!-- Attributes -->
        <div class="sheet-section">
            <div class="sheet-space-between">
                <h2 data-i18n="attributes">Attributes</h2>
                <a class="sheet-pictos" data-i18n-title="show_attributes_popup" href="#attribute-configuration">y</a>
            </div>

            <div class="sheet-flex">
                <div class="sheet-th sheet-grow" data-i18n="attribute">Attribute</div>
                <div class="sheet-th"><div data-i18n-title="base-asterisks" class="sheet-number-width sheet-help"><span data-i18n="base">Base</span>*</div></div>
                <div class="sheet-th"><div class="sheet-number-width" data-i18n="current-abrv">Cur</div></div>
            </div>

            <!-- TODO check attribute-order when done -->
            <div data-i18n-list="attribute-order">
                <!-- Action Points -->
                <div data-i18n-list-item="action_points" class="sheet-flex sheet-hl sheet-creature">
                    <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n="action_points">Action Points</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{action_points_base}" name="attr_action_points_base" value="2" readonly></div>
                    <div class="sheet-td"><div class="sheet-impval sheet-number-width"><input type="number" class="sheet-lval" title="@{action_points}" name="attr_action_points" value="2">/<input type="number" class="sheet-rval" title="@{action_points|max}" name="attr_action_points_max" value="2"></div></div>
                </div>

                <!-- Damage Modifier TODO make damage mod rollable-->
                <div data-i18n-list-item="damage_modifier" class="sheet-flex sheet-hl sheet-creature">
                    <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n-title="damage_modifier" data-i18n="damage_modifier-abrv">Damage Mod</label></div>
                    <div class="sheet-td">
                        <select class="sheet-dullval sheet-number-width sheet-readonly sheet-text-center" title="@{damage_mod_base}" name="attr_damage_mod_base">
                            <option value="-4">-1d8</option>
                            <option value="-3">-1d6</option>
                            <option value="-2">-1d4</option>
                            <option value="-1">-1d2</option>
                            <option value="0" selected>0</option>
                            <option value="1">1d2</option>
                            <option value="2">1d4</option>
                            <option value="3">1d6</option>
                            <option value="4">1d8</option>
                            <option value="5">1d10</option>
                            <option value="6">1d12</option>
                            <option value="7">2d6</option>
                            <option value="8">d8+d6</option>
                            <option value="9">2d8</option>
                            <option value="10">d10+d8</option>
                            <option value="11">2d10</option>
                            <option value="12">2d10+d2</option>
                            <option value="13">2d10+d4</option>
                            <option value="14">2d10+d6</option>
                            <option value="15">2d10+d8</option>
                            <option value="16">3d10</option>
                            <option value="17">3d10+d2</option>
                            <option value="18">3d10+d4</option>
                            <option value="19">3d10+d6</option>
                            <option value="20">3d10+d8</option>
                        </select>
                    </div>
                    <div class="sheet-td">
                        <select class="sheet-impval sheet-number-width sheet-text-center" title="@{damage_mod}" name="attr_damage_mod">
                            <option value="-4">-1d8</option>
                            <option value="-3">-1d6</option>
                            <option value="-2">-1d4</option>
                            <option value="-1">-1d2</option>
                            <option value="0" selected>0</option>
                            <option value="1">1d2</option>
                            <option value="2">1d4</option>
                            <option value="3">1d6</option>
                            <option value="4">1d8</option>
                            <option value="5">1d10</option>
                            <option value="6">1d12</option>
                            <option value="7">2d6</option>
                            <option value="8">d8+d6</option>
                            <option value="9">2d8</option>
                            <option value="10">d10+d8</option>
                            <option value="11">2d10</option>
                            <option value="12">2d10+d2</option>
                            <option value="13">2d10+d4</option>
                            <option value="14">2d10+d6</option>
                            <option value="15">2d10+d8</option>
                            <option value="16">3d10</option>
                            <option value="17">3d10+d2</option>
                            <option value="18">3d10+d4</option>
                            <option value="19">3d10+d6</option>
                            <option value="20">3d10+d8</option>
                        </select>
                    </div>
                </div>

                <!-- Experience Modifier -->
                <div data-i18n-list-item="experience_modifier" class="sheet-flex sheet-hl sheet-major">
                    <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n-title="experience_modifier" data-i18n="experience-abrv_modifier">Exp Modifier</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{experience_mod_base}" name="attr_experience_mod_base" value="0" readonly></div>
                    <div class="sheet-td"><input type="number" class="sheet-impval sheet-number-width" title="@{experience_mod}" name="attr_experience_mod" value="0"></div>
                </div>

                <!-- Healing Rate -->
                <div data-i18n-list-item="healing_rate" class="sheet-flex sheet-hl sheet-creature">
                    <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n="healing_rate">Healing Rate</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{healing_rate_base}" name="attr_healing_rate_base" value="2" readonly></div>
                    <div class="sheet-td"><input type="number" class="sheet-impval sheet-number-width" title="@{healing_rate}" name="attr_healing_rate" value="2"></div>
                </div>

                <!-- Initiative -->
                <div data-i18n-list-item="initiative" class="sheet-flex sheet-hl sheet-creature">
                    <div class="sheet-td sheet-grow sheet-text-left"><button type="roll" class="sheet-label-left" title="%{initiative}" name="roll_initiative" value="@{roll_display}&{template:default} {{yellow=1}} {{character=@{character_name}}} {{name=^{initiative}}} {{^{roll}=[[@{init_dice} + @{initiative_bonus} &{tracker}]]}}" data-i18n="initiative">Initiative</button></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{initiative_bonus_base}" name="attr_initiative_bonus_base" value="12" readonly></div>
                    <div class="sheet-td"><input type="number" class="sheet-impval sheet-number-width" title="@{initiative_bonus}" name="attr_initiative_bonus" value="12"></div>
                </div>

                <!-- Luck Points -->
                <div data-i18n-list-item="luck_points" class="sheet-flex sheet-hl sheet-major">
                    <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n="luck_points">Luck Points</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{luck_points_base}" name="attr_luck_points_base" value="2" readonly></div>
                    <div class="sheet-td"><div class="sheet-impval sheet-number-width"><input type="number" class="sheet-lval" title="@{luck_points}" name="attr_luck_points" value="2">/<input type="number" class="sheet-rval" title="@{luck_points|max}" name="attr_luck_points_max" value="2"></div></div>
                </div>

                <!-- Magic Points -->
                <div data-i18n-list-item="magic_points" class="sheet-flex sheet-hl">
                    <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n="magic_points">Magic Points</label></div>
                    <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{magic_points_base}" name="attr_magic_points_base" value="11" readonly></div>
                    <div class="sheet-td"><div class="sheet-impval sheet-number-width"><input type="number" class="sheet-lval" title="@{magic_points}" name="attr_magic_points" value="11">/<input type="number" class="sheet-rval" title="@{magic_points|max}" name="attr_magic_points_max" value="11"></div></div>
                </div>

                <!-- Movement Rate -->
                <!-- TODO movement_rate-base is a new value -->
                <div data-i18n-list-item="movement" class="sheet-hl">
                    <input type="hidden" class="sheet-wide-toggle" name="attr_custom_movement_enabled" value="0">
                    <div class="sheet-flex sheet-anti-toggle">
                        <div class="sheet-td sheet-grow sheet-text-left"><a class="sheet-label-left" data-i18n-title="show_movement_popup" data-i18n="movement" href="#movement-details">Movement</a></div>
                        <div class="sheet-td"><input type="number" class="sheet-dullval sheet-number-width" title="@{movement_rate_base}" name="attr_movement_rate_base" value="6" readonly></div>
                        <div class="sheet-td"><input type="number" class="sheet-impval sheet-number-width" title="@{movement_rate}" name="attr_movement_rate" value="6"></div>
                    </div>
                    <!-- Custom Movement Alternative -->
                    <div class="sheet-flex sheet-toggle sheet-full-width">
                        <div class="sheet-td sheet-grow sheet-text-left"><label class="sheet-left" data-i18n="movement">Movement</label></div>
                        <div class="sheet-td sheet-custom-movement"><input type="text" class="sheet-full-width sheet-text-right" title="@{custom_movement}" name="attr_custom_movement"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <div class="sheet-compact">
    Compact
</div>
    <!-- Attribute Configuration -->
<div id="attribute-configuration" class="sheet-overlay">
    <div class="sheet-popup">
        <a class="close" href="#">×</a>
        <h1 data-i18n="attributes">Attributes</h1>
    </div>
</div>
    <!-- Movement Details -->
<div id="movement-details" class="sheet-overlay">
    <div class="sheet-popup">
        <a class="close" href="#">×</a>
        <h1 data-i18n="movement">Movement</h1>
    </div>
</div>
</div>
    
    
    

    <!-- Popup Windows -->
    <div id="help" class="sheet-overlay">
    <div class="sheet-popup">
        <a class="close" href="#">×</a>
        <h1 data-i18n="help">Help</h1>
        <!-- TODO: Fill out help page -->
        <input type="text" name="attr_version" value="3.0">
    </div>
</div>
    <div id="import" class="sheet-overlay">
    <div class="sheet-popup">
        <a class="close" href="#">×</a>
        <h1 data-i18n="import">Import</h1>

        <div><label class="sheet-left" data-i18n="import_data">Import Data</label></div>
        <div><textarea class="sheet-full-width" name="attr_import_json_data"></textarea></div>
        <div class="sheet-flex sheet-gap">
            <div>
                <label class="sheet-left sheet-help" title="Character to import from data">#</label>
                <input type="number" class="sheet-number-width-sm" title="@{import_character}" name="attr_import_character" value="1" min="1">
            </div>
            <div>
                <label class="sheet-checkbox">
                    <input type='checkbox' name='attr_import_type' value="major"><span>3</span>
                    <span data-i18n="import_as_player_character">Import as Player Character</span>
                </label>
            </div>
        </div>

        <button type="action" name="act_import" class="sheet-full-width sheet-btn-style" data-i18n="import">Import</button>

        <fieldset class="repeating_systemspecies">
            <input type="text" name="attr_test">
        </fieldset>

        <span style="color: red" name="attr_import_errors"></span>
    </div>
</div>
    <div id="configuration" class="sheet-overlay">
    <div class="sheet-popup">
        <a class="close" href="#">×</a>
        <h1 data-i18n="configuration">Configuration</h1>

        <div class="sheet-bmargin">
            <!-- Sheet Type -->
            <label class="sheet-left sheet-rmargin" data-i18n="sheet_type">Sheet Type</label>
            <select data-i18n-list="sheet-type-order" title="@{type}" class="sheet-undrln sheet-auto-width" name="attr_type">
                <option value="battle_unit" data-i18n-list-item="battle_unit" data-i18n="battle_unit">Battle Unit</option>
                <option value="creature" data-i18n-list-item="creature" data-i18n="creature">Creature</option>
                <option value="pc" data-i18n-list-item="player_character" data-i18n="player_character" selected>Player Character</option>
                <option value="ship" data-i18n-list-item="ship" data-i18n="ship">Ship</option>
                <option value="solar_system" data-i18n-list-item="star_system" data-i18n="star_system">Star System</option>
                <option value="spirit" data-i18n-list-item="spirit" data-i18n="spirit">Spirit</option>
                <option value="vehicle" data-i18n-list-item="vehicle" data-i18n="vehicle">Vehicle</option>
            </select>
            <br>

            <!-- TODO Include species move rate / custom movement in essential configurations -->

            <!-- Intellect -->
            <div class="sheet-minor">
                <label class="sheet-left sheet-rmargin" data-18n="intellect">Intellect</label>
                <select class="sheet-auto-width" name="attr_int_type">
                    <option value="int-u" data-i18n="int-u" selected>INT</option>
                    <option value="ins-u" data-i18n="ins-u">INS</option>
                </select>
            </div>

            <!-- Form -->
            <div class="sheet-creature">
                <label class="sheet-left sheet-rmargin" data-18n="form">Form</label>
                <select class="sheet-undrln sheet-auto-width" title="@{hit_locations}" name="attr_hit_locations" data-i18n-list="hit-location-order">
                    <option value="custom1" data-i18n="custom(1_location)" data-i18n-list-item="custom(1_location)">Custom(1 Location)</option>
                    <option value="custom7" data-i18n="custom(7_locations)" data-i18n-list-item="custom(7_locations)" selected >Custom(7 Locations)</option>
                    <option value="custom8" data-i18n="custom(8_locations)" data-i18n-list-item="custom(8_locations)">Custom(8 Locations)</option>
                    <option value="custom9" data-i18n="custom(9_locations)" data-i18n-list-item="custom(9_locations)">Custom(9 Locations)</option>
                    <option value="custom10" data-i18n="custom(10_locations)" data-i18n-list-item="custom(10_locations)">Custom(10 Locations)</option>
                    <option value="custom11" data-i18n="custom(11_locations)" data-i18n-list-item="custom(11_locations)">Custom(11 Locations)</option>
                    <option value="custom" data-i18n="custom(12_locations)" data-i18n-list-item="custom(12_locations)">Custom(12 Locations)</option>
                    <option value="rabble" data-i18n="rabble/underling" data-i18n-list-item="rabble">Rabble/Underling</option>
                    <option class="sheet-hidden" value="simplified" data-i18n="simplified_combat">Simplified Combat</option>
                    <option data-i18n-list-item="spacer" disabled>──────────</option>
                    <option value="arachnid" data-i18n="arachnid" data-i18n-list-item="arachnid">Arachnid</option>
                    <option value="humanoid" data-i18n="biped" data-i18n-list-item="biped">Biped</option>
                    <option value="centaurid" data-i18n="centaurid" data-i18n-list-item="centaurid">Centaurid</option>
                    <option value="decapoda" data-i18n="decapoda" data-i18n-list-item="decapoda">Decapoda</option>
                    <option value="decapodiform" data-i18n="decapodiform" data-i18n-list-item="decapodiform">Decapodiform</option>
                    <option value="dorsal_finned_aquatic" data-i18n="dorsal_finned_aquatic" data-i18n-list-item="dorsal_finned_aquatic">Dorsal Finned Aquatic</option>
                    <option value="draconic" data-i18n="draconic" data-i18n-list-item="draconic">Draconic</option>
                    <option value="insect" data-i18n="insect" data-i18n-list-item="insect">Insect</option>
                    <option value="octopodiform" data-i18n="octopodiform" data-i18n-list-item="octopodiform">Octopodiform</option>
                    <option value="pachyderm" data-i18n="pachyderm" data-i18n-list-item="pachyderm">Pachyderm</option>
                    <option value="quadruped" data-i18n="quadruped" data-i18n-list-item="quadruped">Quadruped</option>
                    <option value="serpentine" data-i18n="serpentine" data-i18n-list-item="serpentine">Serpentine</option>
                    <option value="tailed_arachnid" data-i18n="tailed_arachnid" data-i18n-list-item="tailed_arachnid">Tailed Arachnid</option>
                    <option value="tailed_biped" data-i18n="tailed_biped" data-i18n-list-item="tailed_biped">Tailed Biped</option>
                    <option value="tailed_quadruped" data-i18n="tailed_quadruped" data-i18n-list-item="tailed_quadruped">Tailed Quadruped</option>
                    <option value="winged_biped" data-i18n="winged_biped" data-i18n-list-item="winged_biped">Winged Biped</option>
                    <option value="winged_insect" data-i18n="winged_insect" data-i18n-list-item="winged_insect">Winged Insect</option>
                    <option value="winged_quadruped" data-i18n="winged_quadruped" data-i18n-list-item="winged_quadruped">Winged Quadruped</option>
                </select>
            </div>

            <!-- Average Species SIZ -->
            <div class="sheet-major">
                <label class="sheet-left sheet-rmargin" data-18n="avg-species-siz">Average Species SIZ</label>
                <input type="number" class="sheet-number-width-sm sheet-undrln" title="@{avg_species_siz}" name="attr_avg_species_siz" value="13">
            </div>
        </div>

        <!-- Campaign Settings -->
        <div class="sheet-section">
            <details>
                <summary><h2 data-i18n="campaign_settings">Campaign Settings</h2></summary>
                <div class="sheet-warnmsg">
                    <span data-i18n="settings-warning">These campaign settings are generally set by your GM and shouldn't be changed.  They are provided here for visibility, and testing.</span>
                </div>

                <!-- Setting -->
                <label class="sheet-left sheet-rmargin" data-18n="setting">Setting</label>
                <select name="attr_setting" data-i18n-list="setting-order">
                    <option value="default" data-i18n="default" selected>Default</option>
                    <option value="after_the_vampire_wars" data-i18n-list-item="after_the_vampire_wars" data-i18n="after_the_vampire_wars">After the Vampire Wars</option>
                    <option value="classic_fantasy" data-i18n-list-item="classic_fantasy" data-i18n="classic_fantasy">Classic Fantasy</option>
                    <option value="destined" data-i18n-list-item="destined" data-i18n="destined">Destined</option>
                    <option value="fioracitta" data-i18n-list-item="fioracitta" data-i18n="fioracitta">Fioracitta</option>
                    <option value="luther_arkwright" data-i18n-list-item="luther_arkwright" data-i18n="luther_arkwright">Luther Arkwright</option>
                    <option value="lyonesse" data-i18n-list-item="lyonesse" data-i18n="lyonesse">Lyonesse</option>
                    <option value="m-space" data-i18n-list-item="m-space" data-i18n="m-space">M-Space</option>
                    <option value="monster_island" data-i18n-list-item="monster_island" data-i18n="monster_island">Monster Island</option>
                    <option value="mythic_babylon" data-i18n-list-item="mythic_babylon" data-i18n="mythic_babylon">Mythic Babylon</option>
                    <option value="mythic_britain" data-i18n-list-item="mythic_britain" data-i18n="mythic_britain">Mythic Britain</option>
                    <option value="mythic_constantinople" data-i18n-list-item="mythic_constantinople" data-i18n="mythic_constantinople">Mythic Constantinople</option>
                    <option value="mythic_rome" data-i18n-list-item="mythic_rome" data-i18n="mythic_rome">Mythic Rome</option>
                    <option value="mythras_imperative" data-i18n-list-item="mythras_imperative" data-i18n="mythras_imperative">Mythras Imperative</option>
                    <option value="odd_soot" data-i18n-list-item="add_soot" data-i18n="odd_soot">Odd Soot</option>
                    <option value="perceforest" data-i18n-list-item="perceforest" data-i18n="perceforest">Perceforest</option>
                    <option value="thennla" data-i18n-list-item="thennla" data-i18n="thennla">Thennla</option>
                    <option value="worlds_united" data-i18n-list-item="worlds_united" data-i18n="worlds_united">Worlds United</option>
                </select>
                <br>

                <!-- Mechanical Systems -->
                <h3 data-i18n="mechanical_systems">Mechanical Systems</h3>
                <!-- Extended Conflict Resolution Option -->
                <label class="sheet-left sheet-rmargin" data-i18n="extended_conflict_resolution">Extended Conflict Resolution</label>
                <select name="attr_extended_conflict_enabled_option">
                    <option value="default" data-i18n="setting_default" selected>Setting Default</option>
                    <option value="1" data-i18n="enabled">Enabled</option>
                    <option value="0" data-i18n="disabled">Disabled</option>
                </select>
                <br>
            </details>
        </div>
    </div>
</div>
</div>

<!-- Roll Templates -->






<script type="text/worker">
const debug=1

/* Campaign Options */
const campaignSettings = ["extended_conflict_enabled"]
const campaginSettingDefaults = {
    "default": {
        "extended_conflict_enabled": 0
    },
    "m-space": {
        "extended_conflict_enabled": 1
    },
    "odd_soot": {
        "extended_conflict_enabled": 1
    }
}
/**
 * Will either return the campaignSettingOption if overridden, otherwise will get the setting default value
 * @param campaignSetting the variable name of the campaign setting
 * @param campaignSettingOption the value of the campaign setting option variable
 * @param setting the selected campaign setting
 * @returns {*} object of new calculated attributes
 */
function calcCampaignSetting(campaignSetting, campaignSettingOption, setting) {
    if (campaignSettingOption === 'default') {
        if ((setting in campaginSettingOverrides) && (`${campaignSetting}` in campaginSettingOverrides[setting])) {
            return campaginSettingOverrides[setting][`${campaignSetting}`];
        } else {
            return campaginSettingDefaults[`${campaignSetting}`];
        }
    } else {
        return {[`${campaignSetting}`]: campaignSettingOption};
    }
}
/* Trigger setting change */
on(`change:setting`, function(event) {
    /* Get an array of option values to get */
    const campaignSettingOptions = campaignSettings.map(function(campaignSetting){
        return `${campaignSetting}_option`;
    })
    getAttrs(campaignSettingOptions, function(v) {
        let newAttrs = {};
        campaignSettings.forEach(campaignSetting => { /* Gather all setting values per new setting */
            newAttrs = {...newAttrs,
                ...calcCampaignSetting(campaignSetting, v[`${campaignSetting}_option`], event.newValue)
            }
        });
        setAttrs(newAttrs);
    });
});
/* Trigger for all the individual campaign setting option values */
campaignSettings.forEach(campaignSetting => {
    on(`change:${campaignSetting}_option`, function(event) {
        getAttrs(['setting'], function(v) {
            setAttrs(calcCampaignSetting(`${campaignSetting}`, event.newValue, v['setting']));
        });
    });
});

/* Type Specific Scripts */
/* Characteristic Triggers */
const characteristicAttrs = ['str', 'con', 'siz', 'dex', 'int', 'pow', 'cha'];
characteristicAttrs.forEach(char => {
    on(`change:${char}_base change:${char}`, function(event) {
        if (event.sourceType === "sheetworker") {return;}

        let newAttrs = {}
        getAttrs([`${char}_base`, `${char}_temp`].concat(characteristicAttrs), function(v) {
            const baseCharVal = parseInt(v[`${char}_base`]) || 0;
            if (event.sourceAttribute.endsWith("_base")) { /* Set the new char value if base was modified */
                const tempCharVal = parseInt(v[`${char}_temp`]) || 0;
                const newCharVal = baseCharVal + tempCharVal;
                newAttrs[`${char}`] = newCharVal;
                v[`${char}`] = newCharVal; /* Override so all other calculations can utilize the new value */
            } else { /* If char edited directly we reverse calculate the temp value */
                const currCharVal = parseInt(v[`${char}`]) || 0;
                newAttrs[`${char}_temp`] = currCharVal - baseCharVal;
            }
            setAttrs(newAttrs);
        });
    });
});

/* Action Point Triggers */

/* Character Import */
/**
 * Sanitizes a name from import data to avoid bugs with buttons and macros in the sheet (removes parenthesis) and will
 * set the name to the character's actual name if a major character import or type if minor character import
 * @param importName
 * @param importType
 * @returns {string}
 */
function getImportName(importName, importType) {
    if (importName.includes('(')) {
        if (importType === 'major') {
            return importName.split('(')[0].replace(/[()]/g, '').trim();
        } else {
            let [start, ...end] = importName.split('(');
            end = end.join("(");
            return end.replace(/[()]/g, '').trim();
        }
    } else {
        return importName.replace(/[()]/g, '').trim();
    }
}

/**
 * Imports JSON data from the Mythras Encounter Generator or other sources which use the same data format
 */
on("clicked:import", function() {
    getAttrs(['import_json_data', 'import_character', 'import_type', 'simplified_combat_enabled', 'luck_points_rank'], function(v) {
        try {
            const jsonData = JSON.parse(v['import_json_data']);
            const import_character = parseInt(v['import_character']);
            /* Check if the requested import character is out of range */
            if (import_character > jsonData.length) {
                setAttrs({
                    import_errors: "Error: The import data contains " + jsonData.length + " character(s) but you requested number " + import_character + "."
                });
                return;
            }
            const characterData = jsonData[parseInt(v['import_character']) - 1];

            let calc_armor_penalty = false;
            let newAttrs = {
                rank: 0,
                str_base: 0, str_temp: 0, str: 0,
                con_base: 0, con_temp: 0, con: 0,
                siz_base: 0, siz_temp: 0, siz: 0,
                dex_base: 0, dex_temp: 0, dex: 0,
                int_base: 0, int_temp: 0, int: 0,
                pow_base: 0, pow_temp: 0, pow: 0,
                cha_base: 0, cha_temp: 0, cha: 0
            };

            /* Import Info */
            if (debug) {console.log('Importing Info');}
            /* Due to differences in parsing we will import name and species after sheet type */
            /* TODO: import cults & notes */

            /* Import Characteristics */
            if (debug) {
                console.log("Importing Characteristics");
            }
            characterData["stats"].forEach(stat => {
                const charKey = Object.keys(stat)[0];
                const char = charKey.toLowerCase();
                newAttrs[`${char}_base`] = stat[charKey];
                newAttrs[`${char}`] = stat[charKey];
            });

            if (debug) {
                console.log("Determining Import Sheet type");
            }
            /* Detect Sheet Character Type, Species, and name */
            if (v['import_type'] === 'major') {
                newAttrs['type'] = 'pc';
            } else {
                /* Elementals have str and dex but no siz and con, so we determine spirit by str and dex only */
                if (newAttrs['str_base'] === 0 && newAttrs['dex_base'] === 0) {
                    newAttrs['type'] = 'spirit';
                } else {
                    newAttrs['type'] = 'creature';
                }
            }
            newAttrs['character_name'] = getImportName(characterData['name'], v['import_type'])

            /* Clear the import data */
            newAttrs['import_json_data'] = '';

            setAttrs(newAttrs);
        } catch (error) {
            setAttrs({import_errors: error});
        }
    });
});

/* Character Versioning */
/**
 * Make the changes needs to get a character sheet updated from 2.7 to 3.0
 */
function upgradeCharacter3Dot0() {
    if (debug) {console.log("Upgrading character to 3.0");}
    let charGetAttrs = [];
    characteristicAttrs.forEach(char => { charGetAttrs.push(`${char}`, `${char}_temp`); });
    getAttrs(charGetAttrs, function(v) {
        let newAttrs = {'version': '3.0'};

        /* Convert Characteristics base values */
        characteristicAttrs.forEach(char => {
            const charCurr = parseInt(v[`${char}`]) || 0;
            const charTemp = parseInt(v[`${char}_temp`]) || 0;
            newAttrs[`${char}_base`] = charCurr - charTemp;
        });

        /* Delete json import data due to size and not needing it anymore, v3 does this for us after import */
        newAttrs['encounter_generator_json'] = '';

        setAttrs(newAttrs);
    });
}


/* Versioning */
/**
 * Compares current sheet version to latest and performs necessary changes to bring the sheet up to date
 * @param type the sheet type attribute
 * @param version the sheet version already parse to a float or 0 if not a valid float
 */
function versioning(type, version) {
    const latestVersion = '3.0';
    if (debug) {console.log(`Current sheet version = ${version}`);}
    version = parseFloat(version) || 0;
    /* Eval sheet version and run upgrade functions as needed, note we have dropped functions of old versions */
    if(version === 0) {
        if (debug) {console.log(`Current version invalid, setting to ${latestVersion}`);}
        setAttrs({['version']: latestVersion});
    } else if (version < 3.0) {
        if (type === 'pc') {upgradeCharacter3Dot0();}
        versioning(type, '3.0');
    }
}

/**
 * Sets a number of attributes containing translations for prompts which normally can't use the i18n systems
 * @returns {} an object of translation attributes
 */
function setTranslationAttrs() {
    setAttrs(
        {}
    );
}

/* On Open Triggers */
on("sheet:opened", function() {
    getAttrs(['type', 'version'], function(v) {
        versioning(v['type'], v['version']);
    });
    setTranslationAttrs();
});
</script>